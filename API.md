# Описание API
Здесь описано всё API, используемое в приложении, с описанием структур данных


**Содержание**
1. Общее
    * 1.1. Адрес сервера
    * 1.2. Используемый протокол
2. Структуры данных
    * 2.1. Общий формат ответа
    * 2.2. Пользователь
    * 2.3. Сообщение
    * 2.4. Комната (лобби)
    * 2.5. Боты
3. Список запросов
    * 3.1. Список ошибок
4. Подробно
    * 4.1. login
    * 4.2. logout
    * 4.3. registration
    * 4.4. math
    * 4.5. createRoom
    * 4.6. renameRoom
    * 4.7. joinToRoom
    * 4.8. leaveRoom
    * 4.9. dropFromRoom
    * 4.10. deleteUser
    * 4.11. startGame
    * 4.12. getRooms
    * 4.13. getUserInfo
    * 4.14. getClasses
    * 4.15. getUserOwnedClasses
    * 4.16. buyClass
    * 4.17. selectClass
    * 4.18. buyItem
    * 4.19. sellItem
    * 4.20. spawnBot
    * 4.21. getBots
    * 4.22. updateBot
    * 4.23. removeBot



## 1. Общее
### 1.1. Адрес сервера
`http://knightwars.local/api`
`http://knightwars:81/api`

### 1.2. Используемый протокол
API полностью реализовано на http(s). 

Формат возвращаемых значений `JSON`.

Все методы, если это особо не оговорено, имеют тип `GET`.


## 2. Структуры данных
### 2.1. Общий формат ответа
T — какие-то данные. В случае успешного ответа возвращается result = 'ok' и поле data с данными.

В случае ошибки возвращается result = 'error' и поле error с кодом и текстом ошибки
```
Answer<T>: {
    result: 'ok' | 'error';
    data?: T;
    error?: {
        code: number;
        text: string;
    };
}
```

### 2.2. Пользователь
```
User: {
    id: number;
    nickname: string;
    token: string;
}

UserInfo: {
    id: number;
    login: string;
    nickname: string;
    money: number;
}
```

### 2.3. Математика
```
MathResult: number[];
```

### 2.4. Комната (лобби)
```
Room: {
    id: number;
    status: 'open' | 'closed' | 'started';
    players_count: number;
}

RoomsResponse: {
    status: 'unchanged' | 'updated';
    hash?: string;
    rooms?: Room[];
}
```

### 2.5. Боты
```
BotsInRooms: {
    id: number,
    room_id: number,
    type: number,
    data: string(JSON),
    name: string,
    hp: number,
    damage: number,
    attack_speed: number,
    attack_distance: number,
    money: number
}
```

## 3. Список запросов
| Название | О чем |
| - | - |
| login | Авторизация пользователя |
| logout | Логаут пользователя |
| registration | Регистрация пользователя |
| math | Решение уравнения (1–4 степени) |
| createRoom | Создание комнаты |
| renameRoom | Переименование комнаты |
| joinToRoom | Присоединение к комнате |
| leaveRoom | Выход из комнаты |
| dropFromRoom | Исключение участника из комнаты |
| deleteUser | Удаление пользователя |
| startGame | Начало игры в комнате |
| getRooms | Получение списка комнат |
| getUserInfo | Получение информации о пользователе |
| getClasses | Получение списка всех доступных классов |
| getUserOwnedClasses | Получение списка купленных пользователем классов |
| buyClass | Покупка класса пользователем |
| selectClass | Выбор активного класса пользователем |
| buyItem | Покупка предмета |
| sellItem | Продажа предмета |
| spawnBot | Создание бота в комнате |
| getBots | Получение списка ботов в комнате |
| updateBot | Обновление данных бота в комнате |
| removeBot | Удаление бота из комнаты |



### 3.1. Список ошибок
* `101` - параметр method не передан
* `102` - метод не найден
* `242` - не переданы все необходимые параметры
* `404` - Not found
* `705` - пользователь не найден
* `706` - персонаж не найден
* `1001` - логин уже существует
* `1002` - неверный логин или пароль
* `1003` - ошибка выхода из системы
* `1004` - ошибка регистрации пользователя
* `1005` - пользователь не существует
* `1006` - пользователь с этим адресом электронной почты уже зарегистрирован
* `1007` - персонаж не создан
* `1008` - класс не назначен
* `1009` - класс не выбран
* `2001` - пользователь уже играет
* `2002` - пользователь уже является владельцем этой комнаты
* `2003` - комната не найдена
* `2004` - пользователь уже в комнате
* `2005` - комната недоступна
* `2006` - пользователь отсутствует в комнате
* `2007` - владелец не может сам себя выгнать
* `2008` - только владелец может выгнать участников комнаты
* `2009` - пользователь, которого нужно выгнать, не найден в комнате
* `2010` - вы не владелец комнаты
* `2011` - комната не найдена или не открыта
* `2012` - недостаточно игроков для начала игры
* `2013` - неверный размер комнаты (должен быть от 1 до 6)
* `2014` - ошибка переименования комнаты
* `3001` - пользователь не купил ни одного класса
* `3002` - класс не найден
* `3003` - пользователь не найден
* `3004` - недостаточно средств для покупки класса
* `3005` - ошибка при покупке класса
* `3006` - класс не куплен
* `3007` - класс уже куплен
* `4001` - предмет не найден
* `4002` - недостаточно денег для покупки
* `4003` - предмет уже куплен
* `4004` - ошибка покупки предмета
* `4005` - достигнут лимит количества для этого типа предмета
* `4006` - предмет не найден в инвентаре
* `4007` - ошибка продажи предмета
* `5001` - тип бота не найден
* `5002` - ошибка создания бота
* `5003` - неверный формат данных бота
* `5004` - бот не найден в комнате
* `5005` - в комнате нет ботов
* `5006` - атакующий пользователь не найден
* `5007` - атакующий пользователь не в комнате
* `5008` - ошибка начисления денежной награды
* `8001` - не передан ни один коэффициент
* `8002` - дискриминант < 0 (нет действительных корней)
* `8003` - нет действительных корней
* `9000` - неизвестная ошибка


## 4. Подробно
### 4.1. login
Авторизация пользователя в системе

**Параметры**
```
{
    "login": "string", - логин пользователя 
    "password": "string" - пароль пользователя
}

```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `1002` - неверный пароль
* `1005` - пользователь не существует


### 4.2. logout
Вылогин пользователя из системы

**Параметры**
```
{
    token: string
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден | не авторизован
* `1003` - ошибка выхода из системы


### 4.3. registration
Зарегистрировать нового ползователя

**Параметры**
```
{
    "login": "string", - логин пользователя 
    "password": "string" - пароль пользователя
    "nickname": "string", - имя пользователя
    "email": "string" - почта пользователя 
}
```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `1001` - такой логин уже существует
* `1004` - ошибка при регистрации пользователя
* `1007` - персонаж не создан
* `1008` - класс не назначен
* `1009` - класс не выбран


### 4.4. math
Решение уравнений 1–4 степени

**Параметры**
```
{
    "a": number, - коэффициент при x^4
    "b": number, - коэффициент при x^3
    "c": number, - коэффициент при x^2
    "d": number, - коэффициент при x
    "e": number  - свободный член
}
```
**Успешный ответ**
```
    Answer<MathResult>
```
**Ошибки**
* `8001` - не передан ни один коэффициент
* `8002` - дискриминант < 0 (нет действительных корней)
* `8003` - нет действительных корней


### 4.5. createRoom
Создание новой комнаты

**Параметры**
```
{
    token: string, - токен пользователя
    roomName: string, - название комнаты
    roomSize: number - размер комнаты (1-6)
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2001` - пользователь уже играет
* `2002` - пользователь уже является владельцем комнаты
* `2013` - неверный размер комнаты


### 4.6. renameRoom
Переименование комнаты

**Параметры**
```
{
    token: string, - токен владельца комнаты
    newRoomName: string - новое название комнаты
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2003` - комната не найдена
* `2010` - вы не владелец комнаты
* `2014` - ошибка переименования комнаты

### 4.7. joinToRoom
Присоединение к существующей комнате

**Параметры**
```
{
    token: string, - токен пользователя
    roomId: number - ID комнаты
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `2001` - пользователь уже играет
* `2002` - пользователь уже является владельцем комнаты
* `2003` - комната не найдена
* `2004` - пользователь уже в комнате
* `2005` - комната недоступна


### 4.8. leaveRoom
Выход из комнаты

**Параметры**
```
{
    token: string, - токен пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2006` - пользователь отсутствует в комнате


### 4.9. dropFromRoom
Исключение участника из комнаты владельцем

**Параметры**
```
{
    token: string, - токен владельца комнаты
    targetToken: string - токен исключаемого пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2007` - владелец не может сам себя выгнать
* `2008` - только владелец может выгнать участников комнаты
* `2009` - пользователь, которого нужно выгнать, не найден в комнате


### 4.10. deleteUser
Удаление пользователя из системы

**Параметры**
```
{
    token: string - токен пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден


### 4.11. startGame
Старт игры в комнате (инициатор - только владелец)

**Параметры**
```
{
    token: string - токен владельца комнаты
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2010` - вы не владелец комнаты
* `2011` - комната не найдена или не открыта
* `2012` - недостаточно игроков для начала игры


### 4.12. getRooms
Получение списка доступных комнат

**Параметры**
```
{
    token: string, - токен пользователя
    room_hash: string - текущий хэш комнат 
}
```
**Успешный ответ**
```
    Answer<RoomsResponse>
```

**Возможные ответы:**
```
{
    status: 'unchanged' - данные не изменились
}
```

```
{
    status: 'updated',
    hash: 'новый_хэш',
    rooms: [
        {
        id: number,
        status: 'open',
        players_count: number
        }
    ] - новые данные
}
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден

### 4.13. getUserInfo
Получение информации о пользователе

**Параметры**
```
{
    "token": "string" - токен пользователя
}
```
**Успешный ответ**
```
   Answer<UserInfo>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден

### 4.14. getClasses
Получение списка всех доступных классов

**Параметры**
```
{}
```
**Успешный ответ**
```
   Answer<Class[]>
```
**Ошибки**
-

### 4.15. getUserOwnedClasses
Получение списка купленных пользователем классов

**Параметры**
```
{
    "token": "string" - токен пользователя
}
```
**Успешный ответ**
```
   Answer<ClassOwned[]>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3001` - Классы не найдены

### 4.16. buyClass
Покупка класса пользователем

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "classId": number - ID класса для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3002` - класс не найден
* `3003` - пользователь не найден
* `3004` - недостаточно средств
* `3005` - ошибка при покупке
* `3007` - класс уже куплен

### 4.17. selectClass
Выбор активного класса пользователем

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "classId": number - ID класса для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3006` - класс не куплен


### 4.18. buyItem
Покупка предмета

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "itemId": number - ID предмета для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `4001` - предмет не найден
* `4002` - недостаточно денег для покупки
* `4003` - предмет уже куплен
* `4004` - ошибка покупки предмета
* `4005` - достигнут лимит количества для этого типа предмета


### 4.19. sellItem
Продажа предмета

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "itemId": number - ID предмета для продажи
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `4001` - предмет не найден
* `4006` - предмет не найден в инвентаре
* `4007` - ошибка продажи предмета


### 4.20. spawnBot
Создание бота в комнате

**Параметры**
```
{
    token: string, - токен владельца комнаты
    botType: string, - тип бота
    botData: string - JSON с данными бота {"hp":,"x":,"y":}
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `2006` - пользователь отсутствует в комнате
* `2010` - вы не владелец комнаты
* `2011` - комната не найдена или игра не начата
* `5001` - тип бота не найден
* `5002` - ошибка создания бота
* `5003` - неверный формат данных бота


### 4.21. getBots
Получение списка ботов в комнате

**Параметры**
```
{
    roomId: number - ID комнаты
}
```
**Успешный ответ**
```
  Answer<BotsInRooms[]>
```

**Ошибки**
* `242` - не переданы все необходимые параметры
* `2003` - комната не найдена
* `5005` - в комнате нет ботов


### 4.22. updateBot
Обновление данных бота в комнате

**Параметры**
```
{
    token: string, - токен владельца комнаты
    botId: number, - ID бота
    botData: string - JSON с новыми данными бота {"hp":,"x":,"y":,"lastHitToken":"string"}
}
```
**Успешный ответ**
```
  Answer<true>
```

**Особенности:**
```
    Если HP ≤ 0 и передан lastHitToken, бот умирает с начислением денег игроку с этим токеном
    Если HP ≤ 0 без lastHitToken, бот умирает без начисления денег игрокам
```

**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2006` - пользователь отсутствует в комнате
* `2010` - вы не владелец комнаты
* `5003` - неверный формат данных бота
* `5004` - бот не найден в комнате
* `5006` - атакующий пользователь не найден
* `5007` - атакующий пользователь не в комнате
* `5008` - ошибка начисления денежной награды


### 4.23. removeBot
Удаление бота из комнаты

**Параметры**
```
{
    token: string, - токен владельца комнаты
    botId: number - ID бота
}
```
**Успешный ответ**
```
  Answer<true>
```

**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2006` - пользователь отсутствует в комнате
* `2010` - вы не владелец комнаты
* `5004` - бот не найден в комнате

